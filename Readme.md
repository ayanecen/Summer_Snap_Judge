# AIサマースコアリング（画像×GPT API）

シンプルなサンプルアプリケーションです。ユーザーがアップロードした写真に対して、GPT系APIを使って「夏らしさ」を採点します。

> ライセンス: MIT License — 詳細はリポジトリの `LICENSE` ファイルを参照してください。

## 主な特徴
- 画像をアップロードしてAIに採点させるワークフロー（自己評価スコア入力あり）
- 画像はサーバ側で自動リサイズしてbase64でAPIへ送信
- リサイズしたJPEGはサーバ上に保存されます（`./resized/YYYY/MM/DD/HHMMSS_<rand>.jpg` 形式）。保存に失敗しても処理は継続します。
- AI応答の堅牢なパース処理とデバッグログ出力（`logs/ai_debug.log`）
- エラー時のフォールバックや再試行ロジックを実装し、応答が空で切られた場合の再呼び出しを行う仕組みあり
- シンプルでレスポンシブなフロントエンド（スライダーで自己評価を指定）

## 動作要件
- PHP 8.0+（推奨 8.1）
- GD（画像リサイズに使用）
- cURL（外部API呼び出し用）
- Webサーバ（Apache等）でのホスティング

## セットアップ（公開用）
1. リポジトリをアップロード
2. `inc/config.php` を開き、`$OPENAI_API_KEY` に自身のAPIキーを設定してください（このファイルは公開しないでください）。
   - オプションで `$OPENAI_MODEL` と `$OPENAI_FALLBACK_MODEL` を指定できます（例：`gpt-5-mini` / `gpt-5-nano`）。
3. ディレクトリのパーミッションを確認・設定してください：
   - `resized/`, `uploads/`, `tmp/`, `logs/` はWebサーバーから書き込み可能にしてください（安全のため最小限の権限で）。
   - 特に `resized/` はリサイズ画像の保存先になります。書き込み権限がないと保存に失敗しますが、処理自体は続行します。
4. `.htaccess`（同梱）により `inc/` 以下の直接アクセスはブロックされています。加えて本リポジトリでは `logs/` と `resized/` にも専用 `.htaccess` を配置しており、公開環境での直接参照を制限しています（Apache向け）。
   - 注意: 一部ホスティング環境では `.htaccess` が無効な場合があります。その場合は `logs/` と `resized/` をウェブルート外に移動してください。

## 実行と使い方
- ブラウザで `index.php` を開き、JPEG/PNG/WEBP の画像を選択して自己評価（スライダー）を入力し送信します。
- 結果ページにAIの評価スコアと短いコメントが表示されます。

## デバッグとログ
- 開発時は `logs/ai_debug.log` にAPI呼び出しのスニペットや json デコードエラー情報が出力されます。
- 結果ページ下部には開発用にエスケープ済みのAPIレスポンスを表示する `details` ブロックを導入できますが、本番化時は無効化することを推奨します（`DEBUG` フラグで制御）。

## セキュリティ注意点
- `inc/config.php` にAPIキーをハードコーディングする場合、そのファイルは公開リポジトリや外部に漏れないようにしてください。
- 本リポジトリでは以下の対策を行っています（ただしホスティング環境によって挙動が異なるため、必ず検証してください）:
  - ルート `.htaccess` により `inc/` への直接アクセスを禁止
  - `logs/.htaccess` と `resized/.htaccess` を配置し、ディレクトリ内ファイルへの直接参照を禁止

- 推奨: 可能であれば `logs/` と `resized/` をウェブルート外に移動し、OSレベルの所有者と権限を最小化してください（例: 所有者=webサーバーユーザ、パーミッション=600/660 など）。
- 一部ホスティングでは `.htaccess` が無効なため、必ずブラウザまたは curl でアクセス遮断を検証してください。

検証例（公開ホストで実行）:
- logs の確認: `curl -I "https://your.example/path/to/logs/ai_debug.log"` → 403 または 404 を期待
- resized の確認: `curl -I "https://your.example/path/to/resized/YYYY/MM/DD/HHMMSS_<rand>.jpg"` → 403 または 404 を期待

## カスタマイズのヒント
- 使用するモデル名やフォールバックの挙動は `inc/config.php` で変更できます。
- レイアウトや色は `assets/style.css` を編集して調整できます。
- フロントエンドの挙動は `assets/script.js` に記載しています（スライダー表示やプレビュー処理など）。

## ライセンス
このリポジトリのコードは MIT License の下で公開しています。  
著作権: Ayane (ayatabi.net) — 詳細は `LICENSE` ファイルを参照してください。

## お問い合わせ
- 問題が発生した場合は `logs/ai_debug.log` の内容と、PHP のエラーログを確認してください。
